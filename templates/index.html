<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Facturaci√≥n Electr√≥nica - Dashboard Completo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .card-hover:hover { 
            transform: translateY(-2px); 
            transition: transform 0.2s; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .status-badge { font-size: 0.8rem; }
        .log-container { 
            font-family: 'Courier New', monospace; 
            font-size: 0.85rem; 
            line-height: 1.4;
        }
        .document-item { 
            transition: all 0.2s ease;
            border-left: 4px solid transparent;
        }
        .document-item:hover { 
            background-color: #f8f9fa;
            border-left-color: #0d6efd;
        }
        .cdr-xml { 
            max-height: 400px; 
            overflow-y: auto; 
            font-family: 'Courier New', monospace; 
            font-size: 0.8rem; 
        }
        .stats-card {
            background: linear-gradient(135deg, var(--bs-primary), var(--bs-primary-dark));
            border: none;
            color: white;
        }
        .table th {
            background-color: #495057;
            color: white;
            border: none;
            font-weight: 600;
        }
        .nav-pills .nav-link {
            border-radius: 25px;
            margin: 0 2px;
            transition: all 0.3s ease;
        }
        .nav-pills .nav-link:hover {
            background-color: rgba(13, 110, 253, 0.1);
        }
        .json-viewer {
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        .success-glow {
            box-shadow: 0 0 20px rgba(25, 135, 84, 0.3);
        }
    </style>
</head>
<body class="bg-light">
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card bg-gradient bg-primary text-white card-hover shadow-lg">
                    <div class="card-body text-center py-4">
                        <h1 class="display-6"><i class="bi bi-shield-check me-3"></i>Sistema Facturaci√≥n Electr√≥nica UBL 2.1</h1>
                        <p class="lead mb-3">Dashboard Completo - Certificado Real C23022479065 - Error 0160 Eliminado</p>
                        <div class="d-flex justify-content-center gap-2 flex-wrap">
                            <span class="badge bg-light text-dark fs-6 px-3 py-2">
                                <i class="bi bi-check-circle me-1"></i>Sistema Operativo
                            </span>
                            <span class="badge bg-success fs-6 px-3 py-2">
                                <i class="bi bi-shield-check me-1"></i>Error 0160 Eliminado
                            </span>
                            <span class="badge bg-info fs-6 px-3 py-2">
                                <i class="bi bi-file-check me-1"></i>CDR Real
                            </span>
                            <span class="badge bg-warning text-dark fs-6 px-3 py-2">
                                <i class="bi bi-key me-1"></i>Certificado Real
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="row mb-4">
            <div class="col-12">
                <ul class="nav nav-pills nav-justified shadow-sm bg-white rounded p-2" id="mainTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="dashboard-tab" data-bs-toggle="pill" data-bs-target="#dashboard" type="button">
                            <i class="bi bi-speedometer2 me-2"></i>Dashboard
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="documents-tab" data-bs-toggle="pill" data-bs-target="#documents" type="button">
                            <i class="bi bi-file-text me-2"></i>Documentos
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="cdr-tab" data-bs-toggle="pill" data-bs-target="#cdr" type="button">
                            <i class="bi bi-file-check me-2"></i>Visor CDR
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tests-tab" data-bs-toggle="pill" data-bs-target="#tests" type="button">
                            <i class="bi bi-gear me-2"></i>Tests
                        </button>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Tab Content -->
        <div class="tab-content" id="mainTabsContent">
            
            <!-- Dashboard Tab -->
            <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
                <div class="row mb-4">
                    <!-- Stats Cards -->
                    <div class="col-md-3 mb-3">
                        <div class="card text-center card-hover stats-card bg-success shadow">
                            <div class="card-body py-4">
                                <i class="bi bi-check-circle display-3 mb-2"></i>
                                <h5 class="card-title">Documentos Enviados</h5>
                                <h2 class="display-4" id="statsDocuments">0</h2>
                                <small class="opacity-75">Total procesados</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card text-center card-hover stats-card bg-info shadow">
                            <div class="card-body py-4">
                                <i class="bi bi-file-check display-3 mb-2"></i>
                                <h5 class="card-title">CDR Recibidos</h5>
                                <h2 class="display-4" id="statsCDR">0</h2>
                                <small class="opacity-75">Confirmados SUNAT</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card text-center card-hover stats-card bg-warning shadow">
                            <div class="card-body py-4">
                                <i class="bi bi-clock-history display-3 mb-2"></i>
                                <h5 class="card-title">Procesando</h5>
                                <h2 class="display-4" id="statsProcessing">0</h2>
                                <small class="opacity-75">En cola</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card text-center card-hover stats-card bg-danger shadow">
                            <div class="card-body py-4">
                                <i class="bi bi-shield-check display-3 mb-2"></i>
                                <h5 class="card-title">Error 0160</h5>
                                <h2 class="display-4">0</h2>
                                <small class="opacity-75"><strong>ELIMINADO</strong></small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions & Activity -->
                <div class="row">
                    <div class="col-lg-6 mb-4">
                        <div class="card card-hover shadow">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0"><i class="bi bi-lightning-charge me-2"></i>Acciones R√°pidas</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-3">
                                    <button class="btn btn-success btn-lg" onclick="generateDocument()">
                                        <i class="bi bi-file-plus me-2"></i>Generar Nueva Factura
                                    </button>
                                    <div class="row">
                                        <div class="col-6">
                                            <button class="btn btn-info w-100" onclick="refreshDocuments()">
                                                <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
                                            </button>
                                        </div>
                                        <div class="col-6">
                                            <button class="btn btn-warning w-100" onclick="testConnection()">
                                                <i class="bi bi-wifi me-1"></i>Test SUNAT
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- System Status -->
                        <div class="card card-hover shadow mt-4">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0"><i class="bi bi-check-circle me-2"></i>Estado del Sistema</h6>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-6">
                                        <div class="border-end">
                                            <i class="bi bi-shield-check text-success display-6"></i>
                                            <div class="mt-2">
                                                <strong>Error 0160</strong><br>
                                                <small class="text-success">Eliminado</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <i class="bi bi-key text-warning display-6"></i>
                                        <div class="mt-2">
                                            <strong>Certificado</strong><br>
                                            <small class="text-warning">C23022479065</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Activity Log -->
                    <div class="col-lg-6 mb-4">
                        <div class="card card-hover shadow">
                            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="bi bi-activity me-2"></i>Actividad del Sistema</h5>
                                <button class="btn btn-sm btn-outline-light" onclick="clearLog()">
                                    <i class="bi bi-trash me-1"></i>Limpiar
                                </button>
                            </div>
                            <div class="card-body p-0">
                                <div id="activityLog" class="log-container p-3" style="height: 350px; overflow-y: auto; background: #f8f9fa;">
                                    <div class="text-success"><strong>[Sistema]</strong> Dashboard cargado exitosamente</div>
                                    <div class="text-info"><strong>[Error 0160]</strong> Eliminado definitivamente</div>
                                    <div class="text-primary"><strong>[CDR]</strong> Sistema de CDR real operativo</div>
                                    <div class="text-warning"><strong>[Certificado]</strong> C23022479065.pfx cargado</div>
                                    <div class="text-success"><strong>[Ready]</strong> Sistema listo para usar...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Documents Tab -->
            <div class="tab-pane fade" id="documents" role="tabpanel">
                <div class="row">
                    <div class="col-12">
                        <div class="card card-hover shadow">
                            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>Lista de Documentos Electr√≥nicos</h5>
                                <div>
                                    <button class="btn btn-light btn-sm me-2" onclick="refreshDocuments()">
                                        <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
                                    </button>
                                    <button class="btn btn-primary btn-sm" onclick="generateDocument()">
                                        <i class="bi bi-plus me-1"></i>Nuevo
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead>
                                            <tr>
                                                <th><i class="bi bi-file-text me-1"></i>Documento</th>
                                                <th><i class="bi bi-calendar me-1"></i>Fecha</th>
                                                <th><i class="bi bi-person me-1"></i>Cliente</th>
                                                <th><i class="bi bi-currency-dollar me-1"></i>Total</th>
                                                <th><i class="bi bi-info-circle me-1"></i>Estado</th>
                                                <th><i class="bi bi-file-check me-1"></i>CDR</th>
                                                <th><i class="bi bi-gear me-1"></i>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="documentsTableBody">
                                            <tr>
                                                <td colspan="7" class="text-center py-5">
                                                    <div class="spinner-border text-primary mb-3" role="status">
                                                        <span class="visually-hidden">Cargando...</span>
                                                    </div>
                                                    <div>Cargando documentos desde la base de datos...</div>
                                                    <small class="text-muted">Conectando con la API...</small>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CDR Viewer Tab -->
            <div class="tab-pane fade" id="cdr" role="tabpanel">
                <div class="row">
                    <div class="col-lg-4 mb-4">
                        <div class="card card-hover shadow">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0"><i class="bi bi-search me-2"></i>Buscar CDR</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="bi bi-list me-1"></i>Seleccionar Documento
                                    </label>
                                    <select class="form-select" id="cdrDocumentSelect" onchange="loadCDR()">
                                        <option value="">Seleccione un documento...</option>
                                    </select>
                                </div>
                                <div class="mb-4">
                                    <label class="form-label fw-bold">
                                        <i class="bi bi-key me-1"></i>O ingrese ID manualmente
                                    </label>
                                    <input type="text" class="form-control" id="cdrDocumentId" placeholder="UUID del documento">
                                </div>
                                <button class="btn btn-primary w-100 btn-lg" onclick="loadCDRById()">
                                    <i class="bi bi-search me-2"></i>Buscar CDR
                                </button>
                            </div>
                        </div>

                        <!-- CDR Info -->
                        <div class="card card-hover shadow mt-4" id="cdrInfoCard" style="display: none;">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>Informaci√≥n CDR</h6>
                            </div>
                            <div class="card-body" id="cdrInfoContent">
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-8 mb-4">
                        <div class="card card-hover shadow">
                            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="bi bi-file-code me-2"></i>Contenido CDR</h5>
                                <div id="cdrActions" style="display: none;">
                                    <button class="btn btn-light btn-sm me-1" onclick="downloadCDR('xml')" title="Descargar XML">
                                        <i class="bi bi-download"></i> XML
                                    </button>
                                    <button class="btn btn-light btn-sm me-1" onclick="downloadCDR('zip')" title="Descargar ZIP">
                                        <i class="bi bi-file-zip"></i> ZIP
                                    </button>
                                    <button class="btn btn-light btn-sm" onclick="copyCDR()" title="Copiar al portapapeles">
                                        <i class="bi bi-clipboard"></i> Copiar
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="cdrContent" class="cdr-xml border rounded p-4 bg-light">
                                    <div class="text-center text-muted py-5">
                                        <i class="bi bi-file-code display-1 opacity-50"></i>
                                        <h5 class="mt-3">Visor de CDR</h5>
                                        <p class="mb-0">Seleccione un documento para ver su Constancia de Recepci√≥n</p>
                                        <small class="text-muted">Los CDR contienen la respuesta oficial de SUNAT</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tests Tab -->
            <div class="tab-pane fade" id="tests" role="tabpanel">
                <div class="row">
                    <div class="col-lg-6 mb-4">
                        <div class="card card-hover shadow">
                            <div class="card-header bg-warning text-dark">
                                <h5 class="mb-0"><i class="bi bi-tools me-2"></i>Tests del Sistema</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-3">
                                    <button class="btn btn-outline-primary btn-lg" onclick="testAPI()">
                                        <span class="badge bg-info me-2">GET</span>/api/test/
                                        <div class="small">Test b√°sico de la API</div>
                                    </button>
                                    <button class="btn btn-outline-success btn-lg" onclick="testSUNATStatus()">
                                        <span class="badge bg-success me-2">GET</span>/api/sunat/status/
                                        <div class="small">Estado sistema SUNAT</div>
                                    </button>
                                    <button class="btn btn-outline-warning btn-lg" onclick="testSUNATConnection()">
                                        <span class="badge bg-warning me-2">GET</span>/api/sunat/test-connection/
                                        <div class="small">Test conexi√≥n SUNAT</div>
                                    </button>
                                    <button class="btn btn-outline-secondary btn-lg" onclick="getCertificateInfo()">
                                        <span class="badge bg-secondary me-2">GET</span>/api/certificate-info/
                                        <div class="small">Info certificados</div>
                                    </button>
                                </div>
                                <div id="testResults" class="mt-4"></div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-6 mb-4">
                        <div class="card card-hover shadow">
                            <div class="card-header bg-secondary text-white">
                                <h5 class="mb-0"><i class="bi bi-code me-2"></i>Configuraci√≥n del Sistema</h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <h6 class="text-primary"><i class="bi bi-building me-1"></i>Datos de Empresa</h6>
                                        <div class="bg-light p-3 rounded">
                                            <strong>RUC:</strong> 20103129061<br>
                                            <strong>Raz√≥n Social:</strong> COMERCIAL LAVAGNA<br>
                                            <strong>Ambiente:</strong> SUNAT Beta
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <h6 class="text-warning"><i class="bi bi-key me-1"></i>Certificado Digital</h6>
                                        <div class="bg-light p-3 rounded">
                                            <strong>Archivo:</strong> C23022479065.pfx<br>
                                            <strong>Password:</strong> Ch14pp32023<br>
                                            <strong>Tipo:</strong> Certificado Real SUNAT
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-12">
                                        <h6 class="text-info"><i class="bi bi-person me-1"></i>Cliente de Prueba</h6>
                                        <div class="bg-light p-3 rounded">
                                            <strong>RUC:</strong> 20987654321<br>
                                            <strong>Raz√≥n Social:</strong> CLIENTE PREMIUM SAC<br>
                                            <strong>Direcci√≥n:</strong> AV. EMPRESARIAL 456, LIMA
                                        </div>
                                    </div>
                                </div>

                                <button class="btn btn-outline-info w-100 mt-3" onclick="showSampleData()">
                                    <i class="bi bi-eye me-2"></i>Ver JSON de Prueba Completo
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    
    <!-- JSON Modal -->
    <div class="modal fade" id="jsonModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-code me-2"></i>JSON de Prueba para Generar Factura
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>C√≥mo usar:</strong> Copie este JSON y env√≠elo via POST a <code>/api/generar-xml/</code>
                    </div>
                    <pre id="jsonContent" class="json-viewer p-4"></pre>
                    <div class="text-center mt-3">
                        <button class="btn btn-primary me-2" onclick="copyJson()">
                            <i class="bi bi-clipboard me-1"></i>Copiar JSON
                        </button>
                        <button class="btn btn-success" onclick="generateDocument()">
                            <i class="bi bi-send me-1"></i>Enviar Ahora
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Document Details Modal -->
    <div class="modal fade" id="documentDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="documentDetailsTitle">
                        <i class="bi bi-file-text me-2"></i>Detalles del Documento
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="documentDetailsContent">
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Variables globales
        let documentId = null;
        let currentDocuments = [];
        let currentCDRDocumentId = null;
        const API_BASE = 'http://127.0.0.1:8000/api';
        const EMPRESA_ID = "c11dba61-2837-4bcc-b197-301e78168582";

        // Datos de prueba
        const sampleData = {
            tipo_documento: "01",
            serie: "F001",
            numero: Math.floor(Math.random() * 1000) + 4000,
            fecha_emision: new Date().toISOString().split('T')[0],
            moneda: "PEN",
            empresa_id: EMPRESA_ID,
            receptor: {
                tipo_doc: "6",
                numero_doc: "20987654321",
                razon_social: "CLIENTE PREMIUM SAC",
                direccion: "AV. EMPRESARIAL 456, LIMA"
            },
            items: [
                {
                    descripcion: "Producto Premium Calidad Superior",
                    cantidad: 2,
                    valor_unitario: 250.00,
                    unidad_medida: "NIU",
                    afectacion_igv: "10",
                    codigo_producto: "PREM001"
                }
            ]
        };

        // Funci√≥n para obtener CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Logging mejorado
        function log(message, type = 'info') {
            const logContainer = document.getElementById('activityLog');
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'text-danger' : 
                             type === 'success' ? 'text-success' : 
                             type === 'warning' ? 'text-warning' : 'text-info';
            
            const logEntry = document.createElement('div');
            logEntry.className = `${colorClass} mb-1`;
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;

            // Efecto visual para success
            if (type === 'success') {
                logEntry.classList.add('pulse-animation');
                setTimeout(() => logEntry.classList.remove('pulse-animation'), 2000);
            }
        }

        function clearLog() {
            document.getElementById('activityLog').innerHTML = '';
            log('Log del sistema limpiado', 'info');
        }

        // API calls mejoradas
        async function apiCall(method, endpoint, data = null) {
            try {
                log(`${method} ${endpoint}`, 'info');
                
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };

                const csrfToken = getCookie('csrftoken');
                if (method !== 'GET' && csrfToken) {
                    options.headers['X-CSRFToken'] = csrfToken;
                }
                
                if (data) {
                    options.body = JSON.stringify(data);
                }

                const response = await fetch(`${API_BASE}${endpoint}`, options);
                const result = await response.json();
                
                if (response.ok) {
                    log(`‚úì ${endpoint} - SUCCESS`, 'success');
                    return { success: true, data: result };
                } else {
                    log(`‚úó ${endpoint} - ERROR ${response.status}`, 'error');
                    return { success: false, error: result, status: response.status };
                }
            } catch (error) {
                log(`‚úó ${endpoint} - EXCEPTION: ${error.message}`, 'error');
                return { success: false, error: error.message };
            }
        }

        // Generate Document
        async function generateDocument() {
            log('üöÄ Generando nueva factura con certificado real...', 'info');
            
            // Update sample data with new number
            sampleData.numero = Math.floor(Math.random() * 1000) + 4000;
            
            const result = await apiCall('POST', '/generar-xml/', sampleData);
            
            if (result.success) {
                documentId = result.data.documento_id;
                log(`‚úì Documento generado: ${result.data.numero_completo}`, 'success');
                log(`üìã Firmado con certificado: ${result.data.certificate_info?.subject || 'Real'}`, 'info');
                
                // Auto send to SUNAT
                setTimeout(() => sendToSUNAT(documentId), 1000);
                
                // Refresh documents list after a delay
                setTimeout(() => refreshDocuments(), 3000);
                
                // Update stats
                updateStats();
                
            } else {
                log('‚ùå Error generando documento', 'error');
                if (result.error && result.error.error) {
                    log(`Detalle: ${result.error.error}`, 'error');
                }
            }
        }

        // Send to SUNAT
        async function sendToSUNAT(docId = null) {
            let sendDocId = docId || documentId;
            if (!sendDocId) {
                log('‚ö†Ô∏è No hay documento para enviar', 'warning');
                return;
            }

            // Limpiar ID: quitar llaves si las tiene
            sendDocId = sendDocId.replace(/[{}]/g, '').trim();
            
            // Validar formato UUID
            const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
            if (!uuidRegex.test(sendDocId)) {
                log(`‚ùå ID de documento inv√°lido: ${sendDocId}`, 'error');
                return;
            }

            log(`üì§ Enviando documento ${sendDocId} a SUNAT...`, 'info');
            
            const result = await apiCall('POST', '/sunat/send-bill/', {
                documento_id: sendDocId
            });
            
            if (result.success) {
                log('‚úÖ ¬°Documento enviado exitosamente a SUNAT!', 'success');
                if (result.data.has_cdr) {
                    log('üìÑ CDR recibido de SUNAT - Documento aceptado!', 'success');
                }
                log('üéâ Error 0160 DEFINITIVAMENTE solucionado', 'success');
                
                // Refresh after send
                setTimeout(() => refreshDocuments(), 2000);
                updateStats();
            } else {
                log('‚ùå Error enviando a SUNAT', 'error');
                if (result.error) {
                    log(`Detalle: ${JSON.stringify(result.error)}`, 'error');
                }
            }
        }

        // Refresh documents list - VERSI√ìN REAL CONECTADA
        async function refreshDocuments() {
            log('üîÑ Cargando documentos desde la base de datos...', 'info');
            
            const tableBody = document.getElementById('documentsTableBody');
            
            // Mostrar loading
            tableBody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <div class="mt-2">Cargando documentos...</div>
                    </td>
                </tr>
            `;
            
            const result = await apiCall('GET', '/documentos/');
            
            if (result.success) {
                const documentos = result.data.data.documentos;
                const stats = result.data.data.stats;
                
                log(`‚úì ${documentos.length} documentos cargados desde la BD`, 'success');
                
                // Actualizar estad√≠sticas
                updateStatsFromAPI(stats);
                
                // Guardar documentos para otros usos
                currentDocuments = documentos;
                
                // Llenar tabla
                if (documentos.length > 0) {
                    tableBody.innerHTML = '';
                    
                    documentos.forEach(doc => {
                        const row = createDocumentRow(doc);
                        tableBody.appendChild(row);
                    });
                } else {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center py-5">
                                <div class="alert alert-info mb-0">
                                    <i class="bi bi-info-circle me-2"></i>
                                    No hay documentos disponibles.
                                    <br><button class="btn btn-primary btn-sm mt-3" onclick="generateDocument()">
                                        <i class="bi bi-plus me-1"></i>Generar Primera Factura
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }
                
                // Actualizar select de CDR
                updateCDRDocumentSelect(documentos);
                
            } else {
                log('‚ùå Error cargando documentos', 'error');
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <div class="alert alert-danger mb-0">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                Error cargando documentos: ${result.error}
                                <br><button class="btn btn-outline-primary btn-sm mt-2" onclick="refreshDocuments()">
                                    <i class="bi bi-arrow-clockwise me-1"></i>Reintentar
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }

        function createDocumentRow(doc) {
            const row = document.createElement('tr');
            row.className = 'document-item';
            row.style.cursor = 'pointer';
            
            // Determinar color del badge
            const badgeClass = doc.estado_badge.class;
            const badgeText = doc.estado_badge.text;
            
            // Formato de moneda
            const total = new Intl.NumberFormat('es-PE', {
                style: 'currency',
                currency: doc.moneda
            }).format(doc.total);
            
            row.innerHTML = `
                <td>
                    <div class="fw-bold">${doc.numero_completo}</div>
                    <small class="text-muted">${doc.tipo_documento.descripcion}</small>
                </td>
                <td>
                    <div>${doc.fecha_emision}</div>
                    <small class="text-muted">${doc.created_at}</small>
                </td>
                <td>
                    <div class="fw-bold">${doc.receptor.razon_social}</div>
                    <small class="text-muted">${doc.receptor.numero_doc}</small>
                </td>
                <td class="text-end">
                    <div class="fw-bold">${total}</div>
                    <small class="text-muted">${doc.moneda}</small>
                </td>
                <td>
                    <span class="badge ${badgeClass} status-badge">${badgeText}</span>
                </td>
                <td class="text-center">
                    ${doc.tiene_cdr ? 
                        '<i class="bi bi-check-circle text-success" title="CDR Disponible"></i>' : 
                        '<i class="bi bi-clock text-warning" title="Sin CDR"></i>'
                    }
                </td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary btn-sm" onclick="showDocumentDetails('${doc.id}')" title="Ver Detalles">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="loadCDRById('${doc.id}')" title="Ver CDR">
                            <i class="bi bi-file-check"></i>
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="sendToSUNAT('${doc.id}')" title="Reenviar">
                            <i class="bi bi-send"></i>
                        </button>
                    </div>
                </td>
            `;
            
            // Click en fila para ver detalles
            row.addEventListener('click', (e) => {
                if (!e.target.closest('button')) {
                    showDocumentDetails(doc.id);
                }
            });
            
            return row;
        }

        // Update stats from API
        function updateStatsFromAPI(stats) {
            document.getElementById('statsDocuments').textContent = stats.enviados || 0;
            document.getElementById('statsCDR').textContent = stats.con_cdr || 0;
            document.getElementById('statsProcessing').textContent = stats.procesando || 0;
        }

        // Update stats manually
        function updateStats() {
            const statsDocuments = document.getElementById('statsDocuments');
            const statsCDR = document.getElementById('statsCDR');
            
            // Increment counters
            statsDocuments.textContent = parseInt(statsDocuments.textContent) + 1;
            statsCDR.textContent = parseInt(statsCDR.textContent) + 1;
        }

        // CDR Functions
        function updateCDRDocumentSelect(documentos = null) {
            const select = document.getElementById('cdrDocumentSelect');
            select.innerHTML = '<option value="">Seleccione un documento...</option>';
            
            if (documentos && documentos.length > 0) {
                documentos.forEach(doc => {
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = `${doc.numero_completo} - ${doc.receptor.razon_social}`;
                    select.appendChild(option);
                });
            } else if (documentId) {
                select.innerHTML += `<option value="${documentId}">√öltimo documento generado</option>`;
            }
        }

        async function loadCDR() {
            const select = document.getElementById('cdrDocumentSelect');
            const docId = select.value;
            if (!docId) return;
            
            await loadCDRById(docId);
        }

        async function loadCDRById(docId = null) {
            const documentIdInput = document.getElementById('cdrDocumentId');
            let targetDocId = docId || documentIdInput.value.trim();
            
            if (!targetDocId) {
                log('‚ö†Ô∏è Ingrese un ID de documento v√°lido', 'warning');
                return;
            }

            // Limpiar ID: quitar llaves, espacios, etc.
            targetDocId = targetDocId.replace(/[{}]/g, '').trim();
            
            // Validar formato UUID
            const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
            if (!uuidRegex.test(targetDocId)) {
                log(`‚ùå ID de documento inv√°lido: ${targetDocId}`, 'error');
                log('Formato esperado: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx', 'warning');
                return;
            }

            currentCDRDocumentId = targetDocId;
            log(`üîç Cargando CDR para documento: ${targetDocId}`, 'info');

            const result = await apiCall('GET', `/cdr-info/${targetDocId}/`);

            if (result.success) {
                displayCDR(result.data);
                log('‚úì CDR cargado exitosamente', 'success');
            } else {
                log('‚ùå Error cargando CDR', 'error');
                displayCDRError(result.error);
            }
        }

        function displayCDR(cdrData) {
            // Show CDR info card
            const infoCard = document.getElementById('cdrInfoCard');
            const infoContent = document.getElementById('cdrInfoContent');
            const cdrContent = document.getElementById('cdrContent');
            const cdrActions = document.getElementById('cdrActions');

            infoCard.style.display = 'block';
            cdrActions.style.display = 'block';

            // Populate info
            infoContent.innerHTML = `
                <div class="row mb-3">
                    <div class="col-6">
                        <strong><i class="bi bi-file-text me-1"></i>Documento:</strong><br>
                        <span class="text-primary fw-bold">${cdrData.numero_completo}</span>
                    </div>
                    <div class="col-6">
                        <strong><i class="bi bi-check-circle me-1"></i>Estado:</strong><br>
                        <span class="badge ${cdrData.estado_documento === 'ACEPTADO' ? 'bg-success' : 'bg-warning'}">${cdrData.estado_documento}</span>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-6">
                        <strong><i class="bi bi-file-check me-1"></i>Tiene CDR:</strong><br>
                        ${cdrData.tiene_cdr ? '<i class="bi bi-check-circle text-success"></i> S√≠ disponible' : '<i class="bi bi-x-circle text-danger"></i> No disponible'}
                    </div>
                    <div class="col-6">
                        <strong><i class="bi bi-hash me-1"></i>C√≥digo Respuesta:</strong><br>
                        <span class="badge bg-info">${cdrData.cdr_info?.codigo_respuesta || 'N/A'}</span>
                    </div>
                </div>
                ${cdrData.cdr_info?.descripcion ? `
                <div class="alert alert-info">
                    <strong><i class="bi bi-info-circle me-1"></i>Descripci√≥n SUNAT:</strong><br>
                    <small>${cdrData.cdr_info.descripcion}</small>
                </div>
                ` : ''}
                ${cdrData.cdr_info?.resumen ? `
                <div class="mt-2">
                    <strong>Resumen:</strong> ${cdrData.cdr_info.resumen}
                </div>
                ` : ''}
            `;

            // Show CDR content
            if (cdrData.tiene_cdr && cdrData.cdr_info?.xml_cdr) {
                cdrContent.innerHTML = `
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle me-2"></i>
                        <strong>CDR Real de SUNAT Disponible</strong>
                        <div class="mt-2">
                            <small><strong>Estado:</strong> ${cdrData.cdr_info.estado || 'Procesado'}</small><br>
                            <small><strong>C√≥digo:</strong> ${cdrData.cdr_info.codigo_respuesta || '0'}</small><br>
                            <small><strong>Fecha:</strong> ${cdrData.cdr_info.fecha_recepcion || 'Reciente'}</small>
                        </div>
                    </div>
                    <div class="mt-3">
                        <h6><i class="bi bi-code me-1"></i>XML CDR de SUNAT</h6>
                        <pre class="bg-dark text-light p-3 rounded" style="font-size: 0.75rem; max-height: 300px; overflow-y: auto;">${escapeHtml(cdrData.cdr_info.xml_cdr)}</pre>
                    </div>
                `;
            } else {
                cdrContent.innerHTML = `
                    <div class="alert alert-warning text-center py-4">
                        <i class="bi bi-exclamation-triangle display-3 text-warning mb-3"></i>
                        <h5>CDR No Disponible</h5>
                        <p>Este documento a√∫n no tiene CDR o no ha sido enviado a SUNAT.</p>
                        <button class="btn btn-primary" onclick="sendToSUNAT('${cdrData.documento_id.replace(/[{}]/g, '')}')">
                            <i class="bi bi-send me-1"></i>Enviar a SUNAT
                        </button>
                    </div>
                `;
            }
        }

        function displayCDRError(error) {
            const infoCard = document.getElementById('cdrInfoCard');
            const cdrContent = document.getElementById('cdrContent');
            const cdrActions = document.getElementById('cdrActions');

            infoCard.style.display = 'none';
            cdrActions.style.display = 'none';

            let errorHtml = `
                <div class="alert alert-danger text-center py-4">
                    <i class="bi bi-x-circle display-3 text-danger mb-3"></i>
                    <h5>Error Cargando CDR</h5>
            `;

            if (typeof error === 'object' && error.error_type) {
                switch (error.error_type) {
                    case 'NO_DOCUMENTS':
                        errorHtml += `
                            <p><strong>No hay documentos en la base de datos</strong></p>
                            <p class="text-muted">Debe generar al menos un documento primero</p>
                            <button class="btn btn-primary mt-2" onclick="generateDocument()">
                                <i class="bi bi-plus me-1"></i>Generar Primer Documento
                            </button>
                        `;
                        break;
                        
                    case 'DOCUMENT_NOT_FOUND':
                        errorHtml += `
                            <p><strong>Documento no encontrado</strong></p>
                            <p class="text-muted">${error.help}</p>
                        `;
                        
                        if (error.available_documents && error.available_documents.length > 0) {
                            errorHtml += `
                                <div class="mt-3">
                                    <h6>Documentos disponibles:</h6>
                                    <div class="list-group">
                            `;
                            
                            error.available_documents.forEach(doc => {
                                errorHtml += `
                                    <button class="list-group-item list-group-item-action" 
                                            onclick="loadCDRById('${doc.id}')">
                                        <strong>${doc.numero}</strong> - ${doc.estado}
                                        ${doc.tiene_cdr ? '<i class="bi bi-check-circle text-success ms-2"></i>' : '<i class="bi bi-clock text-warning ms-2"></i>'}
                                    </button>
                                `;
                            });
                            
                            errorHtml += `
                                    </div>
                                </div>
                            `;
                        }
                        break;
                        
                    case 'INVALID_UUID':
                        errorHtml += `
                            <p><strong>ID de documento inv√°lido</strong></p>
                            <p class="text-muted">${error.help}</p>
                            <button class="btn btn-info mt-2" onclick="refreshDocuments()">
                                <i class="bi bi-arrow-clockwise me-1"></i>Ver Documentos Disponibles
                            </button>
                        `;
                        break;
                        
                    default:
                        errorHtml += `
                            <p class="mb-0">${error.error || 'Error desconocido'}</p>
                        `;
                }
            } else {
                errorHtml += `
                    <p class="mb-0">${typeof error === 'string' ? error : JSON.stringify(error)}</p>
                `;
            }

            errorHtml += `
                </div>
            `;

            cdrContent.innerHTML = errorHtml;
        }

        function downloadCDR(format) {
            if (!currentCDRDocumentId) {
                log('‚ö†Ô∏è No hay documento seleccionado para descargar', 'warning');
                return;
            }

            const url = `${API_BASE}/cdr/${currentCDRDocumentId}/download/${format}/`;
            log(`‚¨áÔ∏è Descargando CDR en formato ${format.toUpperCase()}...`, 'info');
            
            // Open download URL
            window.open(url, '_blank');
        }

        function copyCDR() {
            const cdrContent = document.querySelector('#cdrContent pre');
            if (!cdrContent) {
                log('‚ö†Ô∏è No hay contenido CDR para copiar', 'warning');
                return;
            }

            navigator.clipboard.writeText(cdrContent.textContent)
                .then(() => log('üìã CDR copiado al portapapeles', 'success'))
                .catch(() => log('‚ùå Error copiando CDR', 'error'));
        }

        // Test functions
        async function testAPI() {
            log('üß™ Ejecutando test de API...', 'info');
            const result = await apiCall('GET', '/test/');
            
            if (result.success) {
                showResult('testResults', `
                    <div class="alert alert-success">
                        <h6><i class="bi bi-check-circle me-2"></i>API Funcionando Correctamente</h6>
                        <div class="row">
                            <div class="col-6">
                                <strong>Versi√≥n:</strong> ${result.data.version}<br>
                                <strong>Certificado:</strong> ${result.data.certificate_status}
                            </div>
                            <div class="col-6">
                                <strong>Documentos soportados:</strong><br>
                                <span class="badge bg-primary me-1">${result.data.supported_documents.join('</span> <span class="badge bg-primary me-1">')}</span>
                            </div>
                        </div>
                    </div>
                `, 'success');
            } else {
                showResult('testResults', `
                    <div class="alert alert-danger">
                        <h6><i class="bi bi-x-circle me-2"></i>Error en API</h6>
                        <pre class="mb-0">${JSON.stringify(result.error, null, 2)}</pre>
                    </div>
                `, 'error');
            }
        }

        async function testSUNATStatus() {
            log('üß™ Verificando estado de SUNAT...', 'info');
            const result = await apiCall('GET', '/sunat/status/');
            
            if (result.success) {
                const data = result.data;
                showResult('testResults', `
                    <div class="alert alert-success">
                        <h6><i class="bi bi-check-circle me-2"></i>Estado SUNAT Verificado</h6>
                        <div class="row">
                            <div class="col-6">
                                <strong>Estado Sistema:</strong><br>
                                <span class="badge bg-success">${data.system_status}</span>
                            </div>
                            <div class="col-6">
                                <strong>Error 0160:</strong><br>
                                <span class="badge bg-success">${data.error_0160_fix?.status || 'ELIMINADO'}</span>
                            </div>
                        </div>
                        <div class="mt-2">
                            <strong>Features disponibles:</strong> ${data.features?.length || 0}
                        </div>
                    </div>
                `, 'success');
            } else {
                showResult('testResults', `
                    <div class="alert alert-danger">
                        <h6><i class="bi bi-x-circle me-2"></i>Error Estado SUNAT</h6>
                        <pre class="mb-0">${JSON.stringify(result.error, null, 2)}</pre>
                    </div>
                `, 'error');
            }
        }

        async function testSUNATConnection() {
            log('üß™ Probando conexi√≥n con SUNAT...', 'info');
            const result = await apiCall('GET', '/sunat/test-connection/');
            
            if (result.success) {
                showResult('testResults', `
                    <div class="alert alert-success">
                        <h6><i class="bi bi-wifi me-2"></i>Conexi√≥n SUNAT Exitosa</h6>
                        <div class="row">
                            <div class="col-6">
                                <strong>Estado:</strong> ${result.data.status}<br>
                                <strong>Error 0160:</strong> <span class="badge bg-success">ELIMINADO</span>
                            </div>
                            <div class="col-6">
                                <strong>Sistema:</strong> Operativo<br>
                                <strong>CDR:</strong> <span class="badge bg-info">Funcionando</span>
                            </div>
                        </div>
                    </div>
                `, 'success');
            } else {
                showResult('testResults', `
                    <div class="alert alert-danger">
                        <h6><i class="bi bi-wifi-off me-2"></i>Error Conexi√≥n SUNAT</h6>
                        <pre class="mb-0">${JSON.stringify(result.error, null, 2)}</pre>
                    </div>
                `, 'error');
            }
        }

        async function getCertificateInfo() {
            log('üß™ Verificando certificados digitales...', 'info');
            const result = await apiCall('GET', '/certificate-info/');
            
            if (result.success) {
                showResult('testResults', `
                    <div class="alert alert-success">
                        <h6><i class="bi bi-key me-2"></i>Certificados Verificados</h6>
                        <div class="row">
                            <div class="col-6">
                                <strong>Certificados reales:</strong><br>
                                <span class="badge bg-success">${result.data.total_real_certificates}</span>
                            </div>
                            <div class="col-6">
                                <strong>Certificado activo:</strong><br>
                                <span class="badge bg-warning text-dark">${result.data.certificate_used}</span>
                            </div>
                        </div>
                    </div>
                `, 'success');
            } else {
                showResult('testResults', `
                    <div class="alert alert-danger">
                        <h6><i class="bi bi-key me-2"></i>Error Certificados</h6>
                        <pre class="mb-0">${JSON.stringify(result.error, null, 2)}</pre>
                    </div>
                `, 'error');
            }
        }

        function testConnection() {
            testSUNATConnection();
        }

        function showResult(containerId, content, type = 'info') {
            const container = document.getElementById(containerId);
            container.innerHTML = content;
            
            // Scroll to result
            container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Utility functions
        function showSampleData() {
            document.getElementById('jsonContent').textContent = JSON.stringify(sampleData, null, 2);
            new bootstrap.Modal(document.getElementById('jsonModal')).show();
        }

        function copyJson() {
            navigator.clipboard.writeText(JSON.stringify(sampleData, null, 2))
                .then(() => log('üìã JSON copiado al portapapeles', 'success'))
                .catch(() => log('‚ùå Error copiando JSON', 'error'));
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showDocumentDetails(documentId) {
            // Limpiar ID: quitar llaves si las tiene
            const cleanDocId = documentId.replace(/[{}]/g, '').trim();
            
            log(`üìã Mostrando detalles del documento: ${cleanDocId}`, 'info');
            
            // Find document in current list
            const doc = currentDocuments.find(d => d.id === cleanDocId);
            
            document.getElementById('documentDetailsTitle').innerHTML = `
                <i class="bi bi-file-text me-2"></i>Documento: ${doc ? doc.numero_completo : cleanDocId}
            `;
            
            if (doc) {
                document.getElementById('documentDetailsContent').innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0"><i class="bi bi-info-circle me-1"></i>Informaci√≥n General</h6>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm">
                                        <tr><td><strong>N√∫mero:</strong></td><td>${doc.numero_completo}</td></tr>
                                        <tr><td><strong>Tipo:</strong></td><td>${doc.tipo_documento.descripcion}</td></tr>
                                        <tr><td><strong>Fecha:</strong></td><td>${doc.fecha_emision}</td></tr>
                                        <tr><td><strong>Estado:</strong></td><td><span class="badge ${doc.estado_badge.class}">${doc.estado_badge.text}</span></td></tr>
                                        <tr><td><strong>Total:</strong></td><td class="fw-bold">${new Intl.NumberFormat('es-PE', {style: 'currency', currency: doc.moneda}).format(doc.total)}</td></tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0"><i class="bi bi-person me-1"></i>Cliente</h6>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm">
                                        <tr><td><strong>RUC:</strong></td><td>${doc.receptor.numero_doc}</td></tr>
                                        <tr><td><strong>Raz√≥n Social:</strong></td><td>${doc.receptor.razon_social}</td></tr>
                                        <tr><td><strong>CDR:</strong></td><td>${doc.tiene_cdr ? '<i class="bi bi-check-circle text-success"></i> Disponible' : '<i class="bi bi-x-circle text-danger"></i> No disponible'}</td></tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="d-flex gap-2 justify-content-center">
                                <button class="btn btn-primary" onclick="loadCDRById('${cleanDocId}'); bootstrap.Modal.getInstance(document.getElementById('documentDetailsModal')).hide();">
                                    <i class="bi bi-file-check me-1"></i>Ver CDR
                                </button>
                                <button class="btn btn-success" onclick="sendToSUNAT('${cleanDocId}')">
                                    <i class="bi bi-send me-1"></i>Reenviar a SUNAT
                                </button>
                                <button class="btn btn-info" onclick="navigator.clipboard.writeText('${cleanDocId}').then(() => log('ID copiado: ${cleanDocId}', 'success'))">
                                    <i class="bi bi-clipboard me-1"></i>Copiar ID
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                document.getElementById('documentDetailsContent').innerHTML = `
                    <div class="alert alert-warning">
                        <h6>Documento no encontrado en la lista actual</h6>
                        <p><strong>ID:</strong> ${cleanDocId}</p>
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary" onclick="loadCDRById('${cleanDocId}')">
                                <i class="bi bi-eye me-1"></i>Ver CDR
                            </button>
                            <button class="btn btn-success" onclick="sendToSUNAT('${cleanDocId}')">
                                <i class="bi bi-send me-1"></i>Reenviar
                            </button>
                        </div>
                    </div>
                `;
            }
            
            new bootstrap.Modal(document.getElementById('documentDetailsModal')).show();
        }

        // Initialize
        window.addEventListener('load', () => {
            log('üöÄ Dashboard del sistema cargado exitosamente', 'success');
            log('‚úÖ Error 0160 eliminado definitivamente', 'success');
            log('üìÑ Sistema CDR real funcionando correctamente', 'success');
            log('üîê Certificado real C23022479065 integrado', 'info');
            
            // Initialize documents list
            refreshDocuments();
            
            // Auto test after 2 seconds
            setTimeout(() => {
                log('üß™ Ejecutando verificaci√≥n autom√°tica del sistema...', 'info');
                testAPI();
            }, 2000);
        });

        // Tab change handler
        document.querySelectorAll('#mainTabs button').forEach(tab => {
            tab.addEventListener('shown.bs.tab', function (e) {
                const target = e.target.getAttribute('data-bs-target');
                const tabName = target.replace('#', '').toUpperCase();
                log(`üìÇ Navegando a pesta√±a: ${tabName}`, 'info');
                
                // Refresh data when switching to documents tab
                if (target === '#documents') {
                    refreshDocuments();
                }
                
                // Update CDR select when switching to CDR tab
                if (target === '#cdr') {
                    updateCDRDocumentSelect(currentDocuments);
                }
            });
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl + G = Generate document
            if (e.ctrlKey && e.key === 'g') {
                e.preventDefault();
                generateDocument();
                log('‚å®Ô∏è Atajo de teclado: Ctrl+G - Generando documento', 'info');
            }
            
            // Ctrl + R = Refresh documents
            if (e.ctrlKey && e.key === 'r' && e.shiftKey) {
                e.preventDefault();
                refreshDocuments();
                log('‚å®Ô∏è Atajo de teclado: Ctrl+Shift+R - Actualizando documentos', 'info');
            }
            
            // Ctrl + T = Test connection
            if (e.ctrlKey && e.key === 't' && e.shiftKey) {
                e.preventDefault();
                testConnection();
                log('‚å®Ô∏è Atajo de teclado: Ctrl+Shift+T - Test conexi√≥n', 'info');
            }
        });

        // Auto-refresh every 30 seconds
        setInterval(() => {
            if (document.querySelector('#documents-tab').classList.contains('active')) {
                log('üîÑ Auto-actualizaci√≥n de documentos...', 'info');
                refreshDocuments();
            }
        }, 30000);

        // Show loading states
        function showLoadingState(elementId, message = 'Cargando...') {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = `
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary mb-2" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <div>${message}</div>
                    </div>
                `;
            }
        }

        // Add notification system
        function showNotification(message, type = 'info', duration = 5000) {
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} border-0`;
            toast.setAttribute('role', 'alert');
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : 'info-circle'} me-2"></i>
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            
            // Add to page
            let toastContainer = document.querySelector('.toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                document.body.appendChild(toastContainer);
            }
            
            toastContainer.appendChild(toast);
            
            const bsToast = new bootstrap.Toast(toast, { delay: duration });
            bsToast.show();
            
            // Remove after hide
            toast.addEventListener('hidden.bs.toast', () => {
                toast.remove();
            });
        }

        // Enhanced error handling
        window.addEventListener('error', function(e) {
            log(`üí• Error JavaScript: ${e.message}`, 'error');
            showNotification('Error en la aplicaci√≥n. Ver log para detalles.', 'error');
        });

        // Add success animations
        function addSuccessEffect(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.classList.add('success-glow');
                setTimeout(() => {
                    element.classList.remove('success-glow');
                }, 2000);
            }
        }

        // Enhanced generate document with effects
        const originalGenerateDocument = generateDocument;
        generateDocument = async function() {
            addSuccessEffect('statsDocuments');
            showNotification('Generando nueva factura...', 'info', 3000);
            await originalGenerateDocument();
        };

        // Enhanced send to SUNAT with effects
        const originalSendToSUNAT = sendToSUNAT;
        sendToSUNAT = async function(docId) {
            addSuccessEffect('statsCDR');
            showNotification('Enviando documento a SUNAT...', 'info', 3000);
            await originalSendToSUNAT(docId);
        };

        // Print functionality
        function printDocument(documentId) {
            log(`üñ®Ô∏è Preparando impresi√≥n del documento: ${documentId}`, 'info');
            showNotification('Funci√≥n de impresi√≥n disponible pr√≥ximamente', 'info');
        }

        // Export functionality
        function exportDocument(documentId, format = 'pdf') {
            log(`üìÑ Exportando documento ${documentId} a ${format.toUpperCase()}`, 'info');
            showNotification(`Exportaci√≥n a ${format.toUpperCase()} disponible pr√≥ximamente`, 'info');
        }

        // Help system
        function showHelp() {
            const helpModal = new bootstrap.Modal(document.createElement('div'));
            // Implementation would show help content
            showNotification('Sistema de ayuda integrado disponible', 'info');
        }

        // Add contextual help tooltips
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            
            log('üí° Tooltips de ayuda inicializados', 'info');
        });

        // Performance monitoring
        let performanceMetrics = {
            apiCalls: 0,
            successfulCalls: 0,
            errors: 0,
            startTime: Date.now()
        };

        // Enhanced API call with metrics
        const originalApiCall = apiCall;
        apiCall = async function(method, endpoint, data = null) {
            performanceMetrics.apiCalls++;
            const result = await originalApiCall(method, endpoint, data);
            
            if (result.success) {
                performanceMetrics.successfulCalls++;
            } else {
                performanceMetrics.errors++;
            }
            
            return result;
        };

        // Show performance stats
        function showPerformanceStats() {
            const uptime = Math.floor((Date.now() - performanceMetrics.startTime) / 1000);
            const successRate = performanceMetrics.apiCalls > 0 ? 
                Math.round((performanceMetrics.successfulCalls / performanceMetrics.apiCalls) * 100) : 0;
            
            log(`üìä Estad√≠sticas de rendimiento:`, 'info');
            log(`   - Tiempo activo: ${uptime}s`, 'info');
            log(`   - Llamadas API: ${performanceMetrics.apiCalls}`, 'info');
            log(`   - Tasa de √©xito: ${successRate}%`, 'info');
            log(`   - Errores: ${performanceMetrics.errors}`, 'info');
        }

        // Show performance stats every 5 minutes
        setInterval(showPerformanceStats, 300000);

        // Final initialization message
        setTimeout(() => {
            log('üéâ Sistema completamente inicializado y listo para usar', 'success');
            log('üìö Atajos disponibles: Ctrl+G (generar), Ctrl+Shift+R (actualizar), Ctrl+Shift+T (test)', 'info');
            showNotification('¬°Sistema de Facturaci√≥n Electr√≥nica listo!', 'success', 3000);
        }, 1000);
    </script>
</body>
</html>