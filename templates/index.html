<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Facturación Electrónica - Error 0160 Solucionado</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <h1><i class="bi bi-shield-check me-2"></i>Sistema Facturación Electrónica UBL 2.1</h1>
                        <p class="mb-0">Error 0160 SUNAT Solucionado - Certificado Real C23022479065</p>
                        <div class="mt-2">
                            <span class="badge bg-light text-dark">Sistema Operativo</span>
                            <span class="badge bg-light text-dark">Error 0160 Solucionado</span>
                            <span class="badge bg-light text-dark">Certificado Real</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Tests de Conectividad -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-wifi me-2"></i>Tests de Conectividad</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary" onclick="testAPI()">
                                <span class="badge bg-info">GET</span> /api/test/ - Test básico API
                            </button>
                            <button class="btn btn-outline-info" onclick="testSUNATStatus()">
                                <span class="badge bg-info">GET</span> /api/sunat/status/ - Estado SUNAT
                            </button>
                            <button class="btn btn-outline-warning" onclick="testSUNATConnection()">
                                <span class="badge bg-info">GET</span> /api/sunat/test-connection/ - Conexión
                            </button>
                            <button class="btn btn-outline-secondary" onclick="getCertificateInfo()">
                                <span class="badge bg-info">GET</span> /api/certificate-info/ - Certificado
                            </button>
                        </div>
                        <div id="testResults" class="mt-3"></div>
                    </div>
                </div>
            </div>

            <!-- Proceso Completo -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-rocket me-2"></i>Proceso Completo</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-3">
                                <div class="badge bg-primary rounded-circle p-3" id="step1">1</div>
                            </div>
                            <div class="col-9">
                                <h6>Generar Documento</h6>
                                <button class="btn btn-success btn-sm" onclick="generateDocument()" id="generateBtn">
                                    <i class="bi bi-file-plus me-1"></i>Generar Factura
                                </button>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-3">
                                <div class="badge bg-secondary rounded-circle p-3" id="step2">2</div>
                            </div>
                            <div class="col-9">
                                <h6>Enviar a SUNAT</h6>
                                <button class="btn btn-primary btn-sm" onclick="sendToSUNAT()" id="sendBtn" disabled>
                                    <i class="bi bi-send me-1"></i>Enviar (Error 0160 Fix)
                                </button>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-3">
                                <div class="badge bg-secondary rounded-circle p-3" id="step3">3</div>
                            </div>
                            <div class="col-9">
                                <h6>Verificar CDR</h6>
                                <button class="btn btn-info btn-sm" onclick="checkCDR()" id="cdrBtn" disabled>
                                    <i class="bi bi-check me-1"></i>Verificar CDR
                                </button>
                            </div>
                        </div>

                        <div class="progress mb-3">
                            <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                        </div>

                        <div id="processResults"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Datos de Prueba -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Datos de Prueba</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <strong>RUC Emisor:</strong> 20103129061<br>
                                <strong>Certificado:</strong> C23022479065.pfx<br>
                                <strong>Password:</strong> Ch14pp32023<br>
                            </div>
                            <div class="col-6">
                                <strong>Cliente:</strong> 20987654321<br>
                                <strong>Ambiente:</strong> SUNAT Beta<br>
                                <strong>Usuario:</strong> MODDATOS<br>
                            </div>
                        </div>
                        <button class="btn btn-outline-info btn-sm mt-2" onclick="showSampleData()">
                            Ver JSON de Prueba
                        </button>
                    </div>
                </div>
            </div>

            <!-- Log -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-terminal me-2"></i>Log de Actividad
                            <button class="btn btn-sm btn-outline-light float-end" onclick="clearLog()">
                                Limpiar
                            </button>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="activityLog" style="height: 300px; overflow-y: auto; font-family: monospace; background: #f8f9fa; padding: 10px; border-radius: 4px;">
                            <div>[Iniciando] Sistema cargado</div>
                            <div>[Sistema] Error 0160 fix integrado activo</div>
                            <div>[Ready] Listo para pruebas...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Comandos útiles -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0"><i class="bi bi-code me-2"></i>Comandos cURL de Prueba</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Test básico:</h6>
                                <pre class="bg-light p-2">curl http://127.0.0.1:8000/api/test/</pre>
                            </div>
                            <div class="col-md-6">
                                <h6>Estado SUNAT:</h6>
                                <pre class="bg-light p-2">curl http://127.0.0.1:8000/api/sunat/status/</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para JSON -->
    <div class="modal fade" id="jsonModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">JSON de Prueba para Generar Factura</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <pre id="jsonContent" class="bg-light p-3"></pre>
                    <button class="btn btn-primary" onclick="copyJson()">Copiar JSON</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Variables globales
        let documentId = null;
        let currentStep = 0;
        const API_BASE = 'http://127.0.0.1:8000/api';

        // Obtener empresa ID desde la base de datos
        const EMPRESA_ID = "c11dba61-2837-4bcc-b197-301e78168582"; 

        // Datos de prueba
        const sampleData = {
            tipo_documento: "01",
            serie: "F001",
            numero: Math.floor(Math.random() * 1000) + 2000,
            fecha_emision: new Date().toISOString().split('T')[0],
            moneda: "PEN",
            empresa_id: EMPRESA_ID,
            receptor: {
                tipo_doc: "6",
                numero_doc: "20987654321",
                razon_social: "CLIENTE TEST SAC",
                direccion: "AV. TEST 123, LIMA"
            },
            items: [
                {
                    descripcion: "Producto Error 0160 Fix Test",
                    cantidad: 1,
                    valor_unitario: 100.00,
                    unidad_medida: "NIU",
                    afectacion_igv: "10",
                    codigo_producto: "PROD001"
                }
            ]
        };

        // Función para obtener CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Logging
        function log(message, type = 'info') {
            const logContainer = document.getElementById('activityLog');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'text-danger' : 
                         type === 'success' ? 'text-success' : 
                         type === 'warning' ? 'text-warning' : 'text-info';
            
            const logEntry = document.createElement('div');
            logEntry.className = color;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function clearLog() {
            document.getElementById('activityLog').innerHTML = '';
            log('Log limpiado');
        }

        // Mostrar resultados
        function showResult(containerId, content, type = 'info') {
            const container = document.getElementById(containerId);
            const alertClass = type === 'error' ? 'alert-danger' : 
                              type === 'success' ? 'alert-success' : 
                              type === 'warning' ? 'alert-warning' : 'alert-info';
            
            container.innerHTML = `<div class="alert ${alertClass}">${content}</div>`;
        }

        // Actualizar pasos
        function updateStep(step) {
            currentStep = step;
            for (let i = 1; i <= 3; i++) {
                const stepEl = document.getElementById(`step${i}`);
                if (i <= step) {
                    stepEl.className = 'badge bg-success rounded-circle p-3';
                } else {
                    stepEl.className = 'badge bg-secondary rounded-circle p-3';
                }
            }
            
            const progress = (step / 3) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
        }

        // API calls
        async function apiCall(method, endpoint, data = null) {
            try {
                log(`${method} ${endpoint}`);
                
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };

                // Agregar CSRF token para POST requests
                const csrfToken = getCookie('csrftoken');
                if (method !== 'GET' && csrfToken) {
                    options.headers['X-CSRFToken'] = csrfToken;
                }
                
                if (data) {
                    options.body = JSON.stringify(data);
                }

                const response = await fetch(`${API_BASE}${endpoint}`, options);
                const result = await response.json();
                
                if (response.ok) {
                    log(`✓ ${endpoint} - SUCCESS`, 'success');
                    return { success: true, data: result };
                } else {
                    log(`✗ ${endpoint} - ERROR ${response.status}`, 'error');
                    return { success: false, error: result, status: response.status };
                }
            } catch (error) {
                log(`✗ ${endpoint} - EXCEPTION: ${error.message}`, 'error');
                return { success: false, error: error.message };
            }
        }

        // Tests de conectividad
        async function testAPI() {
            const result = await apiCall('GET', '/test/');
            
            if (result.success) {
                showResult('testResults', `
                    <h6>✓ API Funcionando</h6>
                    <strong>Versión:</strong> ${result.data.version}<br>
                    <strong>Certificado:</strong> ${result.data.certificate_status}<br>
                    <strong>Documentos:</strong> ${result.data.supported_documents.join(', ')}
                `, 'success');
            } else {
                showResult('testResults', `
                    <h6>✗ Error API</h6>
                    <pre>${JSON.stringify(result.error, null, 2)}</pre>
                `, 'error');
            }
        }

        async function testSUNATStatus() {
            const result = await apiCall('GET', '/sunat/status/');
            
            if (result.success) {
                const data = result.data;
                showResult('testResults', `
                    <h6>✓ SUNAT Status</h6>
                    <strong>Estado:</strong> ${data.system_status}<br>
                    <strong>Fix integrado:</strong> ${data.integrated_fix?.is_active ? 'ACTIVO' : 'INACTIVO'}<br>
                    <strong>Features:</strong> ${data.features?.length || 0} disponibles
                `, 'success');
            } else {
                showResult('testResults', `
                    <h6>✗ Error SUNAT Status</h6>
                    <pre>${JSON.stringify(result.error, null, 2)}</pre>
                `, 'error');
            }
        }

        async function testSUNATConnection() {
            const result = await apiCall('GET', '/sunat/test-connection/');
            
            if (result.success) {
                showResult('testResults', `
                    <h6>✓ Conexión SUNAT</h6>
                    <strong>Estado:</strong> ${result.data.status}<br>
                    <strong>Dependencies:</strong> ${Object.keys(result.data.dependencies || {}).join(', ')}
                `, 'success');
            } else {
                showResult('testResults', `
                    <h6>✗ Error Conexión</h6>
                    <pre>${JSON.stringify(result.error, null, 2)}</pre>
                `, 'error');
            }
        }

        async function getCertificateInfo() {
            const result = await apiCall('GET', '/certificate-info/');
            
            if (result.success) {
                showResult('testResults', `
                    <h6>✓ Certificados</h6>
                    <strong>Certificados reales:</strong> ${result.data.total_real_certificates}<br>
                    <strong>Certificado usado:</strong> ${result.data.certificate_used}
                `, 'success');
            } else {
                showResult('testResults', `
                    <h6>✗ Error Certificados</h6>
                    <pre>${JSON.stringify(result.error, null, 2)}</pre>
                `, 'error');
            }
        }

        // Proceso completo
        async function generateDocument() {
            updateStep(1);
            log('Iniciando generación de documento...', 'info');
            
            const result = await apiCall('POST', '/generar-xml/', sampleData);
            
            if (result.success) {
                documentId = result.data.documento_id;
                document.getElementById('sendBtn').disabled = false;
                updateStep(2);
                
                log(`Documento generado: ${result.data.numero_completo}`, 'success');
                
                showResult('processResults', `
                    <h6>✓ Documento Generado y Firmado</h6>
                    <strong>ID:</strong> ${documentId}<br>
                    <strong>Número:</strong> ${result.data.numero_completo}<br>
                    <strong>Estado:</strong> ${result.data.estado}<br>
                    <strong>Certificado:</strong> ${result.data.certificate_info?.certificate_file}<br>
                    <strong>Total:</strong> S/ ${result.data.totales?.total_precio_venta}
                `, 'success');
            } else {
                log('Error generando documento', 'error');
                showResult('processResults', `
                    <h6>✗ Error Generando Documento</h6>
                    <strong>Error:</strong> ${JSON.stringify(result.error)}<br>
                    <strong>Status:</strong> ${result.status}<br>
                    <details>
                        <summary>Ver detalles completos</summary>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    </details>
                `, 'error');
            }
        }

        async function sendToSUNAT() {
            if (!documentId) {
                showResult('processResults', '<h6>⚠ Primero genera un documento</h6>', 'warning');
                return;
            }

            updateStep(2);
            log(`Enviando documento ${documentId} a SUNAT...`, 'info');
            
            const result = await apiCall('POST', '/sunat/send-bill/', {
                documento_id: documentId
            });
            
            if (result.success) {
                document.getElementById('cdrBtn').disabled = false;
                updateStep(3);
                
                const data = result.data;
                let content = `
                    <h6>✓ ENVIADO A SUNAT</h6>
                    <strong>Método:</strong> ${data.method}<br>
                    <strong>Fix versión:</strong> ${data.fix_version}<br>
                    <strong>Duración:</strong> ${data.duration_ms}ms
                `;
                
                if (data.has_cdr) {
                    content += `
                        <hr>
                        <h6>📋 CDR RECIBIDO</h6>
                        <strong>Estado:</strong> ${data.cdr_info?.status}<br>
                        <strong>Mensaje:</strong> ${data.cdr_info?.message}
                    `;
                    log('CDR recibido de SUNAT!', 'success');
                }
                
                showResult('processResults', content, 'success');
                log('ERROR 0160 SOLUCIONADO!', 'success');
                
            } else {
                log('Error enviando a SUNAT', 'error');
                showResult('processResults', `
                    <h6>✗ Error Enviando a SUNAT</h6>
                    <pre>${JSON.stringify(result, null, 2)}</pre>
                `, 'error');
            }
        }

        async function checkCDR() {
            if (!documentId) return;
            
            const result = await apiCall('POST', '/sunat/get-status-cdr/', {
                documento_id: documentId
            });
            
            if (result.success) {
                const data = result.data;
                showResult('processResults', `
                    <h6>📋 Estado CDR</h6>
                    <strong>Documento:</strong> ${data.document_number}<br>
                    <strong>Estado:</strong> ${data.current_status}<br>
                    <strong>Tiene CDR:</strong> ${data.has_cdr ? 'SÍ' : 'NO'}
                    ${data.cdr_info ? `<br><strong>Descripción:</strong> ${data.cdr_info.descripcion}` : ''}
                `, data.has_cdr ? 'success' : 'warning');
            } else {
                showResult('processResults', `
                    <h6>✗ Error consultando CDR</h6>
                    <pre>${JSON.stringify(result.error, null, 2)}</pre>
                `, 'error');
            }
        }

        // Funciones auxiliares
        function showSampleData() {
            document.getElementById('jsonContent').textContent = JSON.stringify(sampleData, null, 2);
            new bootstrap.Modal(document.getElementById('jsonModal')).show();
        }

        function copyJson() {
            navigator.clipboard.writeText(JSON.stringify(sampleData, null, 2))
                .then(() => log('JSON copiado al portapapeles', 'success'))
                .catch(() => log('Error copiando JSON', 'error'));
        }

        // Inicialización
        window.addEventListener('load', () => {
            log('Sistema cargado - Error 0160 fix integrado', 'success');
            
            // Test automático después de 2 segundos
            setTimeout(() => {
                log('Ejecutando test automático...', 'info');
                testAPI();
            }, 2000);
            
            updateStep(1);
        });
    </script>
</body>
</html>