#!/usr/bin/env python
"""
TEST ACTUALIZADO - Sistema SUNAT con Error 0160 INTEGRADO
Archivo: test_sunat_integrated.py
Versi√≥n corregida que reconoce la correcci√≥n integrada
"""

import os
import sys
import django
from pathlib import Path
from datetime import datetime
import json

# Configurar Django
project_path = Path(__file__).parent
sys.path.append(str(project_path))
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'facturacion_electronica.settings')

try:
    django.setup()
    DJANGO_OK = True
except Exception as e:
    DJANGO_OK = False
    DJANGO_ERROR = str(e)

class SUNATIntegratedTest:
    """Test actualizado que reconoce la correcci√≥n Error 0160 integrada"""
    
    def __init__(self):
        self.results = {}
        self.timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
        print("üöÄ TEST SUNAT - ERROR 0160 INTEGRADO ‚úÖ")
        print("=" * 60)
        print(f"‚è∞ Iniciado: {self.timestamp}")
        print()
    
    def run_all_tests(self):
        """Ejecuta todos los tests actualizados"""
        
        self.test_django_setup()
        self.test_dependencies()
        self.test_certificate()
        self.test_database()
        self.test_integrated_error_0160_fix()
        self.test_sunat_endpoints()
        self.test_complete_integration()
        self.generate_final_report()
    
    def test_django_setup(self):
        """Test Django y configuraci√≥n base"""
        print("üìã Test 1: Django y Configuraci√≥n")
        
        if not DJANGO_OK:
            self.results['django'] = {'status': '‚ùå FAIL', 'error': DJANGO_ERROR}
            print(f"   ‚ùå Django: {DJANGO_ERROR}")
            return
        
        try:
            from django.conf import settings
            from documentos.models import DocumentoElectronico, Empresa
            
            self.results['django'] = {
                'status': '‚úÖ COMPLETO',
                'version': django.VERSION,
                'apps_installed': len(settings.INSTALLED_APPS),
                'sunat_config': bool(hasattr(settings, 'SUNAT_CONFIG'))
            }
            print("   ‚úÖ Django configurado correctamente")
            print("   ‚úÖ Configuraci√≥n SUNAT presente")
            
        except Exception as e:
            self.results['django'] = {'status': '‚ùå FAIL', 'error': str(e)}
            print(f"   ‚ùå Error Django: {e}")
    
    def test_dependencies(self):
        """Test dependencias cr√≠ticas para SUNAT"""
        print("\nüì¶ Test 2: Dependencias SUNAT")
        
        critical_deps = {
            'requests': 'Comunicaci√≥n HTTP con SUNAT',
            'lxml': 'Procesamiento XML/CDR', 
            'cryptography': 'Certificados digitales'
        }
        
        optional_deps = {
            'zeep': 'Cliente SOAP (mejora conectividad)'
        }
        
        dep_results = {}
        all_critical_ok = True
        
        # Dependencias cr√≠ticas
        print("   Dependencias Cr√≠ticas:")
        for dep, desc in critical_deps.items():
            try:
                module = __import__(dep)
                version = getattr(module, '__version__', 'OK')
                dep_results[dep] = {'status': '‚úÖ OK', 'version': version, 'critical': True}
                print(f"     ‚úÖ {dep}: {version}")
            except ImportError:
                dep_results[dep] = {'status': '‚ùå MISSING', 'critical': True}
                print(f"     ‚ùå {dep}: FALTANTE - {desc}")
                all_critical_ok = False
        
        # Dependencias opcionales
        print("   Dependencias Opcionales:")
        for dep, desc in optional_deps.items():
            try:
                module = __import__(dep)
                version = getattr(module, '__version__', 'OK')
                dep_results[dep] = {'status': '‚úÖ OK', 'version': version, 'critical': False}
                print(f"     ‚úÖ {dep}: {version}")
            except ImportError:
                dep_results[dep] = {'status': '‚ö†Ô∏è OPCIONAL', 'critical': False}
                print(f"     ‚ö†Ô∏è {dep}: Opcional - {desc}")
        
        self.results['dependencies'] = {
            'details': dep_results,
            'all_critical_ok': all_critical_ok,
            'status': '‚úÖ COMPLETO' if all_critical_ok else '‚ùå INCOMPLETE'
        }
        
        if all_critical_ok:
            print("   üéâ Todas las dependencias cr√≠ticas est√°n instaladas")
        else:
            missing = [dep for dep, info in dep_results.items() 
                      if info.get('critical') and info.get('status') == '‚ùå MISSING']
            print(f"   üîß Instalar: pip install {' '.join(missing)}")
    
    def test_certificate(self):
        """Test certificado digital real"""
        print("\nüîê Test 3: Certificado Digital Real")
        
        cert_path = Path('certificados/production/C23022479065.pfx')
        
        if not cert_path.exists():
            self.results['certificate'] = {
                'status': '‚ùå MISSING',
                'path': str(cert_path)
            }
            print(f"   ‚ùå Certificado no encontrado: {cert_path}")
            return
        
        try:
            cert_size = cert_path.stat().st_size
            
            # Verificar que se puede leer el archivo
            with open(cert_path, 'rb') as f:
                cert_header = f.read(10)
            
            self.results['certificate'] = {
                'status': '‚úÖ DISPONIBLE',
                'path': str(cert_path),
                'size_bytes': cert_size,
                'password_configured': True,
                'certificate_type': 'REAL_PRODUCTION_C23022479065'
            }
            
            print(f"   ‚úÖ Certificado real disponible: {cert_size:,} bytes")
            print("   ‚úÖ Password configurado: Ch14pp32023")
            print("   üéØ Tipo: Certificado REAL de producci√≥n SUNAT")
            
        except Exception as e:
            self.results['certificate'] = {
                'status': '‚ùå ERROR',
                'error': str(e)
            }
            print(f"   ‚ùå Error accediendo certificado: {e}")
    
    def test_database(self):
        """Test base de datos y datos de prueba"""
        print("\nüóÑÔ∏è Test 4: Base de Datos")
        
        if not DJANGO_OK:
            self.results['database'] = {'status': '‚ùå SKIP', 'reason': 'Django no configurado'}
            print("   ‚ùå SKIP: Django no configurado")
            return
        
        try:
            from documentos.models import DocumentoElectronico, Empresa, TipoDocumento
            from django.db import connection
            
            connection.ensure_connection()
            
            empresas_count = Empresa.objects.count()
            docs_count = DocumentoElectronico.objects.count()
            tipos_count = TipoDocumento.objects.count()
            
            # Buscar documento listo para env√≠o
            doc_ready = DocumentoElectronico.objects.filter(
                xml_firmado__isnull=False,
                estado__in=['FIRMADO', 'FIRMADO_SIMULADO']
            ).first()
            
            self.results['database'] = {
                'status': '‚úÖ OPERATIVO',
                'empresas_count': empresas_count,
                'documentos_count': docs_count,
                'tipos_documento_count': tipos_count,
                'test_document_ready': bool(doc_ready),
                'test_document_id': str(doc_ready.id) if doc_ready else None
            }
            
            print(f"   ‚úÖ Conexi√≥n establecida")
            print(f"   üìä Empresas: {empresas_count}")
            print(f"   üìä Documentos: {docs_count}")  
            print(f"   üìä Tipos documento: {tipos_count}")
            print(f"   üß™ Documento listo para env√≠o: {'‚úÖ S√ç' if doc_ready else '‚ùå NO'}")
            
        except Exception as e:
            self.results['database'] = {'status': '‚ùå ERROR', 'error': str(e)}
            print(f"   ‚ùå Error base de datos: {e}")
    
    def test_integrated_error_0160_fix(self):
        """Test correcci√≥n Error 0160 INTEGRADA"""
        print("\nüîß Test 5: Correcci√≥n Error 0160 INTEGRADA")
        
        try:
            # Verificar que la correcci√≥n est√° integrada en views_sunat
            from api_rest.views_sunat import IntegratedError0160Fix
            
            # Test de la clase integrada
            fixer = IntegratedError0160Fix()
            
            # Verificar m√©todos principales
            required_methods = [
                'fix_error_0160_integrated',
                '_super_verify_xml_integrated', 
                '_create_bulletproof_zip_integrated',
                '_send_with_verification_integrated'
            ]
            
            available_methods = [method for method in dir(fixer) 
                               if not method.startswith('__')]
            
            has_all_methods = all(method in available_methods for method in required_methods)
            
            self.results['error_0160_fix'] = {
                'status': '‚úÖ INTEGRADO',
                'integration_type': 'BUILT_IN_VIEWS_SUNAT',
                'class_loaded': True,
                'has_all_methods': has_all_methods,
                'methods_count': len(available_methods),
                'external_files_required': False
            }
            
            print("   üéâ Correcci√≥n Error 0160 INTEGRADA detectada")
            print("   ‚úÖ Clase IntegratedError0160Fix cargada")
            print(f"   ‚úÖ M√©todos disponibles: {len(available_methods)}")
            print("   ‚úÖ No requiere archivos externos")
            print("   üéØ Ubicaci√≥n: api_rest/views_sunat.py")
            
        except ImportError:
            self.results['error_0160_fix'] = {
                'status': '‚ùå NO_INTEGRADO',
                'error': 'IntegratedError0160Fix no encontrada en views_sunat'
            }
            print("   ‚ùå Correcci√≥n integrada no encontrada")
            
        except Exception as e:
            self.results['error_0160_fix'] = {
                'status': '‚ùå ERROR',
                'error': str(e)
            }
            print(f"   ‚ùå Error verificando correcci√≥n: {e}")
    
    def test_sunat_endpoints(self):
        """Test endpoints SUNAT con correcci√≥n integrada"""
        print("\nüåê Test 6: Endpoints SUNAT")
        
        if not DJANGO_OK:
            self.results['sunat_endpoints'] = {'status': '‚ùå SKIP'}
            print("   ‚ùå SKIP: Django no configurado")
            return
        
        try:
            from api_rest.views_sunat import (
                SendBillToSUNATView, TestSUNATConnectionView, 
                SUNATStatusView, IntegratedSystemTest
            )
            from django.test import RequestFactory
            
            # Test endpoint de status
            factory = RequestFactory()
            request = factory.get('/api/sunat/status/')
            
            view = SUNATStatusView()
            response = view.get(request)
            
            if response.status_code == 200:
                data = response.data
                system_status = data.get('system_status', 'UNKNOWN')
                integrated_fix = data.get('integrated_fix', {})
                
                # Test r√°pido integrado
                quick_test = IntegratedSystemTest.run_quick_test()
                
                self.results['sunat_endpoints'] = {
                    'status': '‚úÖ OPERATIVO',
                    'status_endpoint_ok': True,
                    'system_status': system_status,
                    'integrated_fix_active': integrated_fix.get('is_active', False),
                    'quick_test_status': quick_test.get('overall_status', 'UNKNOWN'),
                    'endpoints_available': True
                }
                
                print("   ‚úÖ Status endpoint: FUNCIONANDO")
                print(f"   üìä Estado sistema: {system_status}")
                print(f"   üîß Fix integrado activo: {'‚úÖ S√ç' if integrated_fix.get('is_active') else '‚ùå NO'}")
                print(f"   üß™ Test r√°pido: {quick_test.get('overall_status', 'UNKNOWN')}")
                
            else:
                self.results['sunat_endpoints'] = {
                    'status': '‚ùå ERROR_HTTP',
                    'http_status': response.status_code
                }
                print(f"   ‚ùå Error HTTP: {response.status_code}")
                
        except Exception as e:
            self.results['sunat_endpoints'] = {
                'status': '‚ùå ERROR',
                'error': str(e)
            }
            print(f"   ‚ùå Error endpoints: {e}")
    
    def test_complete_integration(self):
        """Test integraci√≥n completa del sistema"""
        print("\nüéØ Test 7: Integraci√≥n Completa")
        
        # Evaluar componentes principales
        components = {
            'django': self.results.get('django', {}).get('status', '').startswith('‚úÖ'),
            'dependencies': self.results.get('dependencies', {}).get('all_critical_ok', False),
            'certificate': self.results.get('certificate', {}).get('status', '').startswith('‚úÖ'),
            'database': self.results.get('database', {}).get('status', '').startswith('‚úÖ'),
            'error_0160_fix': self.results.get('error_0160_fix', {}).get('status', '').startswith('‚úÖ'),
            'sunat_endpoints': self.results.get('sunat_endpoints', {}).get('status', '').startswith('‚úÖ')
        }
        
        # Calcular salud del sistema
        total_components = len(components)
        healthy_components = sum(components.values())
        health_percentage = (healthy_components / total_components) * 100
        
        # Determinar estado final
        if health_percentage >= 90:
            final_status = 'üéâ EXCELENTE'
            message = 'Sistema completamente operativo - Error 0160 solucionado'
            ready_for_production = True
        elif health_percentage >= 75:
            final_status = '‚úÖ MUY BUENO'
            message = 'Sistema operativo con componentes menores pendientes'
            ready_for_production = True
        elif health_percentage >= 50:
            final_status = '‚ö†Ô∏è FUNCIONAL'
            message = 'Sistema funcional - requiere optimizaciones'
            ready_for_production = False
        else:
            final_status = '‚ùå CR√çTICO'
            message = 'Sistema requiere configuraci√≥n urgente'
            ready_for_production = False
        
        # Verificar capacidad de env√≠o SUNAT
        sunat_ready = (
            components['dependencies'] and
            components['certificate'] and
            components['error_0160_fix'] and
            components['sunat_endpoints']
        )
        
        self.results['complete_integration'] = {
            'status': final_status,
            'message': message,
            'health_percentage': health_percentage,
            'healthy_components': healthy_components,
            'total_components': total_components,
            'component_status': components,
            'sunat_ready': sunat_ready,
            'ready_for_production': ready_for_production,
            'error_0160_solved': components['error_0160_fix']
        }
        
        print(f"   üìä Estado final: {final_status}")
        print(f"   üíØ Salud sistema: {health_percentage:.1f}%")
        print(f"   üîß Error 0160 solucionado: {'‚úÖ S√ç' if components['error_0160_fix'] else '‚ùå NO'}")
        print(f"   üöÄ Listo para SUNAT: {'‚úÖ S√ç' if sunat_ready else '‚ùå NO'}")
        print(f"   üìã Componentes OK: {healthy_components}/{total_components}")
    
    def generate_final_report(self):
        """Genera reporte final actualizado"""
        print("\n" + "=" * 60)
        print("üìã REPORTE FINAL - ERROR 0160 INTEGRADO")
        print("=" * 60)
        
        integration_info = self.results.get('complete_integration', {})
        final_status = integration_info.get('status', '‚ùå UNKNOWN')
        health_percentage = integration_info.get('health_percentage', 0)
        sunat_ready = integration_info.get('sunat_ready', False)
        error_0160_solved = integration_info.get('error_0160_solved', False)
        
        print(f"‚è∞ Completado: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        print(f"üéØ Estado Final: {final_status}")
        print(f"üíØ Salud Sistema: {health_percentage:.1f}%")
        print(f"üîß Error 0160: {'‚úÖ SOLUCIONADO' if error_0160_solved else '‚ùå PENDIENTE'}")
        print(f"üöÄ Listo SUNAT: {'‚úÖ S√ç' if sunat_ready else '‚ùå NO'}")
        print()
        
        # Estado por componente
        print("üìä ESTADO POR COMPONENTE:")
        component_status = integration_info.get('component_status', {})
        for component, is_ok in component_status.items():
            status_icon = '‚úÖ' if is_ok else '‚ùå'
            print(f"   {component:20} : {status_icon}")
        
        print()
        
        # Recomendaciones espec√≠ficas
        if sunat_ready:
            print("üéâ SISTEMA LISTO PARA USAR:")
            print("   1. ‚úÖ Error 0160 solucionado e integrado")
            print("   2. ‚úÖ Certificado real disponible")
            print("   3. ‚úÖ Dependencias instaladas")
            print("   4. üöÄ PROBAR ENV√çO:")
            print("      ‚Ä¢ POST /api/sunat/send-bill/")
            print("      ‚Ä¢ Con documento_id de un documento firmado")
            print("      ‚Ä¢ Deber√≠a obtener CDR real de SUNAT")
        else:
            print("üîß ACCIONES PENDIENTES:")
            
            if not component_status.get('dependencies'):
                print("   1. Instalar dependencias faltantes")
            
            if not component_status.get('certificate'):
                print("   2. Configurar certificado C23022479065.pfx")
                
            if not component_status.get('error_0160_fix'):
                print("   3. Verificar correcci√≥n Error 0160 integrada")
        
        print()
        
        # Informaci√≥n t√©cnica
        print("üí° INFORMACI√ìN T√âCNICA:")
        print("   üîß Error 0160: Correcci√≥n INTEGRADA en views_sunat.py")
        print("   üìã No requiere archivos externos")
        print("   üéØ Certificado: C23022479065.pfx (REAL)")
        print("   üåê Ambiente: SUNAT Beta")
        print("   üìä Test status: GET /api/sunat/status/")
        
        # Guardar reporte
        self._save_report()
        
        print("\n" + "=" * 60)
        print("üéâ TEST INTEGRADO COMPLETADO")
        print("=" * 60)
    
    def _save_report(self):
        """Guarda el reporte en archivo JSON"""
        try:
            report_dir = Path('temp') / 'test_reports'
            report_dir.mkdir(parents=True, exist_ok=True)
            
            report_file = report_dir / f'sunat_integrated_test_{datetime.now().strftime("%Y%m%d_%H%M%S")}.json'
            
            with open(report_file, 'w', encoding='utf-8') as f:
                json.dump({
                    'test_type': 'SUNAT_INTEGRATED_ERROR_0160',
                    'timestamp': self.timestamp,
                    'results': self.results,
                    'summary': {
                        'status': self.results.get('complete_integration', {}).get('status'),
                        'health_percentage': self.results.get('complete_integration', {}).get('health_percentage'),
                        'sunat_ready': self.results.get('complete_integration', {}).get('sunat_ready'),
                        'error_0160_solved': self.results.get('complete_integration', {}).get('error_0160_solved')
                    }
                }, f, indent=2, default=str)
            
            print(f"üíæ Reporte guardado: {report_file}")
            
        except Exception as e:
            print(f"‚ö†Ô∏è No se pudo guardar reporte: {e}")


def main():
    """Funci√≥n principal"""
    try:
        tester = SUNATIntegratedTest()
        tester.run_all_tests()
        return 0
        
    except KeyboardInterrupt:
        print("\n‚ö†Ô∏è Test interrumpido por usuario")
        return 1
        
    except Exception as e:
        print(f"\n‚ùå Error ejecutando test: {e}")
        import traceback
        traceback.print_exc()
        return 1


if __name__ == '__main__':
    exit(main())