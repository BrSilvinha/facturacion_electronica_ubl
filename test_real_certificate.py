#!/usr/bin/env python
"""
Script para probar certificado real integrado
Ejecutar: python test_real_certificate.py
"""

import os
import sys
import django
import requests
import json
from pathlib import Path
from datetime import datetime, date

# Configurar Django
BASE_DIR = Path(__file__).parent
sys.path.append(str(BASE_DIR))
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'facturacion_electronica.settings')

# Inicializar Django
django.setup()

from documentos.models import Empresa, TipoDocumento, DocumentoElectronico

class RealCertificateTest:
    """Tester para certificado real"""
    
    def __init__(self):
        self.base_url = "http://localhost:8000/api"
        self.ruc = "20103129061"
        
    def test_1_certificate_info(self):
        """Test 1: Verificar informaci√≥n de certificados"""
        print("üîç TEST 1: Informaci√≥n de certificados")
        print("-" * 50)
        
        try:
            # Llamar endpoint de certificados
            response = requests.get(f"{self.base_url}/certificate-info/")
            
            if response.status_code == 200:
                data = response.json()
                
                if data.get('success'):
                    certificates = data.get('certificates', [])
                    real_certs = data.get('total_real_certificates', 0)
                    test_certs = data.get('total_test_certificates', 0)
                    
                    print(f"   ‚úÖ Endpoint funcionando")
                    print(f"   üìä Total certificados: {len(certificates)}")
                    print(f"   üîê Certificados reales: {real_certs}")
                    print(f"   üß™ Certificados de prueba: {test_certs}")
                    
                    # Buscar tu certificado
                    tu_cert = None
                    for cert in certificates:
                        if cert['ruc'] == self.ruc:
                            tu_cert = cert
                            break
                    
                    if tu_cert:
                        print(f"   ‚úÖ Tu certificado encontrado:")
                        print(f"      - RUC: {tu_cert['ruc']}")
                        print(f"      - Empresa: {tu_cert['empresa']}")
                        print(f"      - Tipo: {tu_cert['certificate_type']}")
                        print(f"      - Es real: {tu_cert['is_real']}")
                        
                        if tu_cert['is_real']:
                            print(f"   üéâ ¬°CERTIFICADO REAL DETECTADO!")
                            return True
                        else:
                            print(f"   ‚ö†Ô∏è A√∫n usando certificado de prueba")
                            return False
                    else:
                        print(f"   ‚ùå Tu RUC {self.ruc} no encontrado")
                        return False
                else:
                    print(f"   ‚ùå Error en respuesta: {data.get('error')}")
                    return False
            else:
                print(f"   ‚ùå Error HTTP: {response.status_code}")
                return False
                
        except Exception as e:
            print(f"   ‚ùå Error: {e}")
            return False
    
    def test_2_certificate_validation(self):
        """Test 2: Validar certificado espec√≠fico"""
        print(f"\nüîê TEST 2: Validaci√≥n de certificado para RUC {self.ruc}")
        print("-" * 50)
        
        try:
            # Llamar endpoint de validaci√≥n espec√≠fica
            data = {"ruc": self.ruc}
            response = requests.post(
                f"{self.base_url}/certificate-info/",
                json=data,
                headers={'Content-Type': 'application/json'}
            )
            
            if response.status_code == 200:
                result = response.json()
                
                if result.get('success'):
                    cert_info = result.get('certificate_info', {})
                    
                    print(f"   ‚úÖ Validaci√≥n exitosa")
                    print(f"   üìÑ Tipo: {cert_info.get('certificate_type')}")
                    print(f"   üîê Es real: {cert_info.get('is_real')}")
                    print(f"   üìÅ Ruta: {cert_info.get('certificate_path')}")
                    print(f"   üìù Descripci√≥n: {cert_info.get('description')}")
                    
                    # Verificar si se pudo cargar
                    is_valid = cert_info.get('certificate_valid', False)
                    
                    if is_valid:
                        print(f"   ‚úÖ Certificado cargado correctamente:")
                        print(f"      - Sujeto: {cert_info.get('certificate_subject')}")
                        print(f"      - Expira: {cert_info.get('certificate_expires')}")
                        print(f"      - Tama√±o clave: {cert_info.get('key_size')} bits")
                        return True
                    else:
                        print(f"   ‚ùå Error cargando certificado:")
                        print(f"      - Error: {cert_info.get('certificate_error')}")
                        return False
                else:
                    print(f"   ‚ùå Error: {result.get('error')}")
                    return False
            else:
                print(f"   ‚ùå Error HTTP: {response.status_code}")
                return False
                
        except Exception as e:
            print(f"   ‚ùå Error: {e}")
            return False
    
    def test_3_xml_generation_with_real_cert(self):
        """Test 3: Generar XML con certificado real"""
        print(f"\nüìÑ TEST 3: Generaci√≥n XML con certificado real")
        print("-" * 50)
        
        try:
            # Obtener empresa
            empresa = Empresa.objects.filter(ruc=self.ruc).first()
            if not empresa:
                print(f"   ‚ùå Empresa con RUC {self.ruc} no encontrada")
                return False
            
            # Datos de prueba
            test_data = {
                "tipo_documento": "01",
                "serie": "F001",
                "numero": int(datetime.now().strftime('%Y%m%d%H%M')),  # N√∫mero √∫nico
                "fecha_emision": date.today().isoformat(),
                "moneda": "PEN",
                "empresa_id": str(empresa.id),
                "receptor": {
                    "tipo_doc": "1",
                    "numero_doc": "12345678",
                    "razon_social": "CLIENTE CON CERTIFICADO REAL",
                    "direccion": "Direcci√≥n del cliente con cert real"
                },
                "items": [
                    {
                        "descripcion": "Producto firmado con certificado real SUNAT",
                        "cantidad": 1,
                        "valor_unitario": 150.00,
                        "unidad_medida": "NIU",
                        "afectacion_igv": "10",
                        "codigo_producto": "REAL001"
                    }
                ]
            }
            
            print(f"   üì§ Enviando datos de prueba...")
            print(f"   üìã Documento: {test_data['tipo_documento']}-{test_data['serie']}-{test_data['numero']}")
            print(f"   üè¢ Empresa: {empresa.razon_social}")
            
            # Enviar a API
            response = requests.post(
                f"{self.base_url}/generar-xml/",
                json=test_data,
                headers={'Content-Type': 'application/json'}
            )
            
            if response.status_code == 200:
                result = response.json()
                
                if result.get('success'):
                    print(f"   ‚úÖ XML generado exitosamente:")
                    print(f"      - ID: {result.get('documento_id')}")
                    print(f"      - N√∫mero: {result.get('numero_completo')}")
                    print(f"      - Estado: {result.get('estado')}")
                    print(f"      - Tipo firma: {result.get('signature_type')}")
                    print(f"      - Hash: {result.get('hash', '')[:20]}...")
                    
                    # Verificar informaci√≥n del certificado
                    cert_info = result.get('certificate_info', {})
                    if cert_info:
                        print(f"   üîê Informaci√≥n del certificado usado:")
                        print(f"      - Sujeto: {cert_info.get('subject')}")
                        print(f"      - Expira: {cert_info.get('expires', '')[:10]}")
                        print(f"      - Es real: {cert_info.get('is_real')}")
                        print(f"      - Tama√±o clave: {cert_info.get('key_size')} bits")
                        
                        if cert_info.get('is_real'):
                            print(f"   üéâ ¬°FIRMADO CON CERTIFICADO REAL DE SUNAT!")
                        else:
                            print(f"   ‚ö†Ô∏è Firmado con certificado de prueba")
                    
                    # Verificar XML firmado
                    xml_firmado = result.get('xml_firmado', '')
                    if xml_firmado:
                        xml_size = len(xml_firmado)
                        has_signature = 'ds:Signature' in xml_firmado
                        has_signature_value = 'ds:SignatureValue' in xml_firmado
                        
                        print(f"   üìÑ XML firmado:")
                        print(f"      - Tama√±o: {xml_size} caracteres")
                        print(f"      - Contiene ds:Signature: {has_signature}")
                        print(f"      - Contiene ds:SignatureValue: {has_signature_value}")
                        
                        if has_signature and has_signature_value:
                            print(f"   ‚úÖ XML contiene firma digital v√°lida")
                            
                            # Guardar XML para inspecci√≥n
                            xml_file = Path(f'xml_real_cert_{test_data["numero"]}.xml')
                            with open(xml_file, 'w', encoding='utf-8') as f:
                                f.write(xml_firmado)
                            
                            print(f"   üíæ XML guardado en: {xml_file}")
                            
                            return True
                        else:
                            print(f"   ‚ùå XML no contiene firma v√°lida")
                            return False
                    else:
                        print(f"   ‚ùå No se recibi√≥ XML firmado")
                        return False
                else:
                    print(f"   ‚ùå Error generando XML: {result.get('error')}")
                    return False
            else:
                print(f"   ‚ùå Error HTTP: {response.status_code}")
                if response.text:
                    print(f"   üìÑ Respuesta: {response.text[:200]}...")
                return False
                
        except Exception as e:
            print(f"   ‚ùå Error: {e}")
            import traceback
            traceback.print_exc()
            return False
    
    def test_4_sunat_integration(self):
        """Test 4: Integraci√≥n con SUNAT usando certificado real"""
        print(f"\nüåê TEST 4: Integraci√≥n SUNAT con certificado real")
        print("-" * 50)
        
        try:
            # Buscar documento reciente firmado
            documento = DocumentoElectronico.objects.filter(
                empresa__ruc=self.ruc,
                estado__in=['FIRMADO', 'FIRMADO_SIMULADO']
            ).order_by('-created_at').first()
            
            if not documento:
                print(f"   ‚ö†Ô∏è No hay documentos firmados para enviar")
                print(f"   üí° Ejecuta primero el test 3")
                return False
            
            print(f"   üìÑ Documento encontrado: {documento.get_numero_completo()}")
            print(f"   üìä Estado: {documento.estado}")
            print(f"   üí∞ Total: {documento.moneda} {documento.total}")
            
            # Intentar env√≠o a SUNAT
            data = {"documento_id": str(documento.id)}
            
            print(f"   üì§ Enviando a SUNAT...")
            
            response = requests.post(
                f"{self.base_url}/sunat/send-bill/",
                json=data,
                headers={'Content-Type': 'application/json'}
            )
            
            if response.status_code == 200:
                result = response.json()
                
                if result.get('success'):
                    print(f"   ‚úÖ Env√≠o exitoso:")
                    print(f"      - Documento: {result.get('document_number')}")
                    print(f"      - Estado: {result.get('document_status')}")
                    
                    sunat_response = result.get('sunat_response', {})
                    if sunat_response:
                        print(f"      - M√©todo: {sunat_response.get('method')}")
                        print(f"      - Duraci√≥n: {sunat_response.get('duration_ms')}ms")
                    
                    # Verificar CDR si est√° disponible
                    cdr_info = result.get('cdr_info')
                    if cdr_info:
                        print(f"   üìã Informaci√≥n CDR:")
                        print(f"      - Aceptado: {cdr_info.get('is_accepted')}")
                        print(f"      - C√≥digo: {cdr_info.get('response_code')}")
                        print(f"      - Descripci√≥n: {cdr_info.get('response_description')}")
                    
                    return True
                else:
                    error = result.get('error', 'Error desconocido')
                    print(f"   ‚ö†Ô∏è Error en env√≠o: {error}")
                    
                    # Algunos errores son esperados en Beta
                    if any(keyword in error.lower() for keyword in ['beta', 'authentication', 'connection']):
                        print(f"   üí° Error esperado en ambiente Beta")
                        return True
                    
                    return False
            else:
                print(f"   ‚ùå Error HTTP: {response.status_code}")
                return False
                
        except Exception as e:
            print(f"   ‚ùå Error: {e}")
            return False
    
    def test_5_compare_certificates(self):
        """Test 5: Comparar certificado real vs prueba"""
        print(f"\nüîÄ TEST 5: Comparaci√≥n certificado real vs prueba")
        print("-" * 50)
        
        try:
            # Obtener info de todos los certificados
            response = requests.get(f"{self.base_url}/certificate-info/")
            
            if response.status_code == 200:
                data = response.json()
                
                if data.get('success'):
                    certificates = data.get('certificates', [])
                    
                    print(f"   üìä Resumen de certificados:")
                    
                    real_count = 0
                    test_count = 0
                    
                    for cert in certificates:
                        ruc = cert['ruc']
                        empresa = cert['empresa']
                        cert_type = cert['certificate_type']
                        is_real = cert['is_real']
                        
                        status = "üîê REAL" if is_real else "üß™ PRUEBA"
                        highlight = " ‚≠ê" if ruc == self.ruc else ""
                        
                        print(f"      {status} | {ruc} | {empresa[:30]}...{highlight}")
                        
                        if is_real:
                            real_count += 1
                        else:
                            test_count += 1
                    
                    print(f"")
                    print(f"   üìà Estad√≠sticas:")
                    print(f"      - Certificados reales: {real_count}")
                    print(f"      - Certificados de prueba: {test_count}")
                    print(f"      - Total: {len(certificates)}")
                    
                    # Verificar tu certificado espec√≠fico
                    tu_cert = next((c for c in certificates if c['ruc'] == self.ruc), None)
                    
                    if tu_cert:
                        print(f"")
                        print(f"   ‚≠ê Tu certificado ({self.ruc}):")
                        print(f"      - Tipo: {tu_cert['certificate_type']}")
                        print(f"      - Es real: {tu_cert['is_real']}")
                        print(f"      - Descripci√≥n: {tu_cert['description']}")
                        
                        if tu_cert['is_real']:
                            print(f"   üéâ ¬°Est√°s usando certificado REAL de SUNAT!")
                            return True
                        else:
                            print(f"   ‚ö†Ô∏è A√∫n usando certificado de prueba")
                            return False
                    else:
                        print(f"   ‚ùå Tu RUC no encontrado en la lista")
                        return False
                else:
                    print(f"   ‚ùå Error: {data.get('error')}")
                    return False
            else:
                print(f"   ‚ùå Error HTTP: {response.status_code}")
                return False
                
        except Exception as e:
            print(f"   ‚ùå Error: {e}")
            return False
    
    def run_all_tests(self):
        """Ejecutar todos los tests"""
        print("üöÄ SUITE DE TESTS - CERTIFICADO REAL")
        print("=" * 60)
        print(f"üìã RUC objetivo: {self.ruc}")
        print(f"üåê API Base: {self.base_url}")
        print(f"üìÖ Fecha: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        print("")
        
        # Verificar que el servidor est√© corriendo
        try:
            response = requests.get(f"{self.base_url}/test/", timeout=5)
            if response.status_code != 200:
                print("‚ùå Error: El servidor Django no est√° corriendo")
                print("üí° Ejecuta: python manage.py runserver")
                return False
        except requests.exceptions.ConnectionError:
            print("‚ùå Error: No se puede conectar al servidor Django")
            print("üí° Ejecuta: python manage.py runserver")
            return False
        
        # Ejecutar tests
        tests = [
            ("Informaci√≥n de certificados", self.test_1_certificate_info),
            ("Validaci√≥n de certificado", self.test_2_certificate_validation),
            ("Generaci√≥n XML con cert real", self.test_3_xml_generation_with_real_cert),
            ("Integraci√≥n SUNAT", self.test_4_sunat_integration),
            ("Comparaci√≥n certificados", self.test_5_compare_certificates),
        ]
        
        passed = 0
        total = len(tests)
        
        for test_name, test_func in tests:
            print(f"üß™ {test_name}")
            try:
                if test_func():
                    passed += 1
                    print(f"   ‚úÖ PASS")
                else:
                    print(f"   ‚ùå FAIL")
            except Exception as e:
                print(f"   ‚ùå ERROR: {e}")
            print("")
        
        # Reporte final
        success_rate = (passed / total) * 100
        
        print("=" * 60)
        print("üìä REPORTE FINAL - CERTIFICADO REAL")
        print("=" * 60)
        print(f"‚úÖ Tests pasados: {passed}/{total}")
        print(f"üìà Tasa de √©xito: {success_rate:.1f}%")
        
        if passed == total:
            print(f"\nüéâ ¬°TODOS LOS TESTS PASARON!")
            print(f"üîê Tu certificado real est√° funcionando perfectamente")
            print(f"‚úÖ Sistema listo para producci√≥n con firma SUNAT real")
        elif passed >= 3:
            print(f"\n‚úÖ MAYOR√çA DE TESTS PASARON")
            print(f"üîê Certificado real detectado y funcionando")
            print(f"‚ö†Ô∏è Algunos problemas menores")
        else:
            print(f"\n‚ùå VARIOS TESTS FALLARON")
            print(f"üí° Verifica la configuraci√≥n del certificado real")
        
        return passed == total

if __name__ == '__main__':
    print("üîê TESTER DE CERTIFICADO REAL SUNAT")
    print("Versi√≥n: 2.0 Professional")
    print("")
    
    tester = RealCertificateTest()
    success = tester.run_all_tests()
    
    if success:
        print(f"\nüéâ ¬°CERTIFICADO REAL FUNCIONANDO AL 100%!")
    else:
        print(f"\n‚ö†Ô∏è REVISAR CONFIGURACI√ìN DE CERTIFICADO")
    
    print(f"\nPresiona Enter para continuar...")
    input()